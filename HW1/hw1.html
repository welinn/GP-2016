<!DOCTYPE html>

<html>
<head>
<style>

#info {
  position: absolute;
  top: 2%;
  width: 100%;
  padding: 10px;
  text-align: center;
  color: #ffff00
}

body {
  overflow: hidden;
}

#dashboard{
  position: absolute;
  bottom: 0px;
  height:90px;
  width:180px;
  border-radius: 90px 90px 0 0;
  -moz-border-radius: 90px 90px 0 0;
  -webkit-border-radius: 90px 90px 0 0;
  background: #123456;
}
</style>
</head>

<body>
<div id="info">HW1
<a href='https://clara.io/view/08ed923e-d978-4b78-a19a-f28bd48e985a'>*</a>
</div>
<div id="dashboard"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r76/three.min.js"></script>
<script src="https://dl.dropboxusercontent.com/u/3587259/Code/Threejs/OrbitControls.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>

var camera, scene, renderer, controls;
var model, brakeOn, power, rot, mass;
var pos, vel, force;
var clock;

$('body').keydown(onKeypress);

init();
animate();

function init() {
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
  camera.position.set(0, 200, 200);
  scene.add(camera);


  var gridXZ = new THREE.GridHelper(100, 10);
  gridXZ.setColors(new THREE.Color(0xff0000), new THREE.Color(0xffffff));
  scene.add(gridXZ);

  renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x888888);

  controls = new THREE.OrbitControls(camera, renderer.domElement);

  model = new THREE.Object3D();
  pos = new THREE.Vector3();
  vel = new THREE.Vector3();
  force = new THREE.Vector3();
  clock = new THREE.Clock(false);
  brakeOn = false;
  power = 5;
  rot = 0;
  mass = 1;

  $.getJSON('model.json', function(data) {
    var loader = new THREE.ObjectLoader();
    var object = loader.parse(data);
    object.scale.set(7, 7, 7);
    object.position.set(-32, -30, 10);
    object.rotation.y = Math.PI;
    model.add(object);
  });
  scene.add(model);

  window.addEventListener('resize', onWindowResize, false);
  document.body.appendChild(renderer.domElement);
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function onKeypress(event) {

  if ((event.which === 37  || event.keyCode === 37) && rot < Math.PI/3) {
    rot += 0.1;
  } else if ((event.which === 39  || event.keyCode === 39) && rot > -Math.PI/3) {
    rot -= 0.1;
  } else if (event.which === 38  || event.keyCode === 38) {  //up
    power += 0.3;
  } else if ((event.which === 40  || event.keyCode === 40) && force > 0.3) {  //down
    power -= 0.3;
  } else if(event.which === 32  || event.keyCode === 32){ //space
    brakeOn = true;
  } else if(event.which === 36  || event.keyCode === 36){ //Home
    brakeOn = false;
    clock.start();
    power = 5;
  }
}

function run(){

  computeForce();
  var dt = clock.getDelta();
  // vel = vel + force/mass * dt
  vel.add (force.clone().multiplyScalar(dt/mass));
  // pos = pos + vel * dt
  pos.add (vel.clone().multiplyScalar(dt));

  model.position.copy (pos);
  model.rotation.y = Math.atan2(-vel.z, vel.x);
  if(brakeOn === true && vel.length() < 3) clock.stop();
}


function computeForce() {

  force = brakeOn ? new THREE.Vector3(0, 0, 0) : new THREE.Vector3(1, 0, 0).applyAxisAngle(new THREE.Vector3(0, 1, 0), model.rotation.y + rot).multiplyScalar(power);

  var alpha = 0.4;  // drag
  force.add (vel.clone().multiplyScalar(-alpha));
}

function animate() {

  if(clock.running) run();
  controls.update();
  requestAnimationFrame(animate);
  render();
}

function render() {
  renderer.render(scene, camera);
}

</script>
</body>
</html>

